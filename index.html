<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ•™å®¤å¤§è€ƒé©— - ç²‰å½©ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* å®šç¾©ç²‰é»ƒã€ç²‰è—åŸºèª¿é¡è‰² */
        :root {
            --bg-color: #FFFBF0; /* ç±³ç™½è‰²èƒŒæ™¯ */
            --main-blue: #AEC6CF; /* ç²‰è— (ä¸»è‰²) */
            --main-yellow: #FDFD96; /* ç²‰é»ƒ (å¼·èª¿è‰²) */
            --text-color: #555; /* æ·±ç°æ–‡å­— */
            --correct: #77DD77; /* ç¶ è‰²æ­£ç¢º */
            --wrong: #FF6961; /* ç´…è‰²éŒ¯èª¤ */
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            text-align: center;
            overscroll-behavior-y: contain; 
        }

        h1, h2 { color: var(--main-blue); text-shadow: 1px 1px 0px #fff; }

        /* æŒ‰éˆ•æ¨£å¼ (åœ“è§’ã€é™°å½±) */
        .btn {
            background-color: var(--main-blue);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1.2rem;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 4px 0 #8aaebd;
            transition: transform 0.1s;
            margin: 10px;
            min-width: 200px;
            font-weight: bold;
        }
        .btn:active { transform: translateY(4px); box-shadow: 0 0 0 #8aaebd; }
        .btn-yellow { background-color: #e3e354; color: #555; box-shadow: 0 4px 0 #caca4b; }

        /* é é¢åˆ‡æ›æ§åˆ¶ */
        .screen { display: none; max-width: 600px; margin: 0 auto; }
        .active { display: block; }

        /* éŠæˆ²å€åŸŸæ¨£å¼ */
        .game-container {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 20px;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆï¼šæ‰‹æ©Ÿç‰ˆæ”¹ç‚ºä¸Šä¸‹æ’åˆ— */
        @media (max-width: 600px) {
            .game-container { flex-direction: column; }
        }

        /* å¡ç‰‡æ§½ä½æ¨£å¼ */
        .card-slot {
            background: white;
            border: 3px solid var(--main-blue);
            border-radius: 15px;
            padding: 10px;
            min-height: 80px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* åœ–ç‰‡å®¹å™¨æ¨£å¼ */
        .img-box {
            width: 100px;
            height: 80px;
            background-color: #eee;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .img-box img { width: 100%; height: 100%; object-fit: cover; }

        /* å¯æ‹–æ›³é …ç›®æ¨£å¼ */
        .draggable-item {
            background-color: var(--main-yellow);
            padding: 10px;
            border-radius: 10px;
            cursor: grab;
            font-weight: bold;
            margin: 5px 0;
            user-select: none; /* é˜²æ­¢é¸å–æ–‡å­— */
            touch-action: none; /* å„ªåŒ–è§¸æ§ */
        }

        /* éŠæˆ² B ç‰¹æœ‰æ¨£å¼ */
        .timeline-area {
            background: rgba(174, 198, 207, 0.2);
            border-radius: 20px;
            padding: 15px;
            min-height: 300px;
        }
        .timeline-label { font-size: 0.8rem; color: #888; margin: 5px 0; font-weight: bold; }
        
        /* çµæœå›é¥‹ */
        .wrong-answer { border: 3px solid var(--wrong) !important; animation: shake 0.5s; }
        .correct-answer { border: 3px solid var(--correct) !important; background-color: #eaffea; }

        #loading-msg { font-weight: bold; color: var(--main-blue); margin-top: 10px; }

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
            100% { transform: translateX(0); }
        }
    </style>
</head>
<body>

    <div id="menu-screen" class="screen active">
        <h1>ğŸ« æ•™å®¤å¤§è€ƒé©— ğŸ«</h1>
        <p>è«‹é¸æ“‡ä¸€å€‹éŠæˆ²é–‹å§‹æŒ‘æˆ°ï¼</p>
        <div id="loading-msg">æ­£åœ¨è®€å–é¡Œç›®è³‡æ–™...</div>
        <button class="btn" onclick="startGame('A')">éŠæˆ² Aï¼šåç¨±é€£é€£çœ‹</button>
        <br>
        <button class="btn" onclick="startGame('B')">éŠæˆ² Bï¼šæ–°èˆŠæ’æ’çœ‹</button>
    </div>

    <div id="game-a-screen" class="screen">
        <h2>ğŸ“ æ•™å®¤åç¨±é€£é€£çœ‹</h2>
        <p>è«‹å°‡å³å´åç¨±æ‹–æ›³åˆ°å·¦å´æ­£ç¢ºç…§ç‰‡ä¸Š</p>
        <div class="game-container">
            <div id="game-a-left" style="flex: 1;"></div>
            <div id="game-a-right" style="flex: 1;"></div>
        </div>
        <button class="btn" onclick="checkGameA()">é€å‡ºç­”æ¡ˆ</button>
        <button class="btn btn-yellow" onclick="showScreen('menu-screen')">å›é¦–é </button>
    </div>

    <div id="game-b-screen" class="screen">
        <h2>â³ æ–°èˆŠæ•™å®¤æ’æ’çœ‹</h2>
        <p>å°‡ä¸‹æ–¹ç…§ç‰‡æ‹–å…¥æ™‚é–“è»¸ï¼Œç”±èˆŠ(ä¸Š)åˆ°æ–°(ä¸‹)æ’åˆ—</p>
        <div class="game-container">
            <div style="flex: 1;">
                <h3>å¾…é¸å€</h3>
                <div id="game-b-source" style="min-height: 100px; border: 2px dashed #ccc; border-radius: 10px; padding:10px;"></div>
            </div>
            <div style="flex: 1;" class="timeline-area">
                <div class="timeline-label">â¬†ï¸ æœ€èˆŠ (Oldest)</div>
                <div id="game-b-target" style="min-height: 250px;"></div>
                <div class="timeline-label">â¬‡ï¸ æœ€æ–° (Newest)</div>
            </div>
        </div>
        <button class="btn" onclick="checkGameB()">é€å‡ºç­”æ¡ˆ</button>
        <button class="btn btn-yellow" onclick="showScreen('menu-screen')">å›é¦–é </button>
    </div>

    <script>
        // --- å…¨åŸŸè®Šæ•¸ ---
        let rawData = [];
        let currentLevelData = [];
        let isDataLoaded = false;

        // --- CSV è®€å–é‚è¼¯ (ç¶²é è¼‰å…¥æ™‚è‡ªå‹•åŸ·è¡Œ) ---
        window.onload = function() {
            Papa.parse("classrooms.csv", {
                download: true,
                header: true,
                dynamicTyping: true, // è‡ªå‹•å°‡å¹´ä»½ (year) è½‰ç‚ºæ•¸å­—ï¼Œé€™æ˜¯éŠæˆ² B æ’åºçš„é—œéµ
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.data && results.data.length > 0) {
                        rawData = results.data;
                        
                        // å°‡ CSV è£¡çš„ filenameOrUrl æ¬„ä½å°æ‡‰åˆ°ç¨‹å¼ç”¨çš„ img å±¬æ€§
                        rawData.forEach(item => {
                            item.img = item.filenameOrUrl; 
                        });

                        isDataLoaded = true;
                        document.getElementById('loading-msg').style.display = 'none'; // éš±è—è¼‰å…¥ä¸­è¨Šæ¯
                        console.log("è³‡æ–™è®€å–æˆåŠŸï¼å…± " + rawData.length + " ç­†");
                    } else {
                        alert("è®€å–åˆ°çš„ CSV æ˜¯ç©ºçš„ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆå…§å®¹ï¼");
                    }
                },
                error: function(err) {
                    document.getElementById('loading-msg').innerText = "è®€å–è³‡æ–™å¤±æ•—ï¼";
                    document.getElementById('loading-msg').style.color = "red";
                    alert("è®€å– classrooms.csv å¤±æ•—ï¼\nè«‹ç¢ºèªï¼š\n1. æª”æ¡ˆæ˜¯å¦å·²ä¸Šå‚³åˆ° GitHub\n2. æª”åå¤§å°å¯«æ˜¯å¦å®Œå…¨æ­£ç¢º (éœ€ç‚º classrooms.csv)");
                    console.error(err);
                }
            });
        }

        // --- æ ¸å¿ƒå‡½æ•¸ï¼šéŠæˆ² B çš„è³‡æ–™ç¯©é¸ ---
        function getUniqueYearClassrooms(data) {
            if (data.length === 0) return [];

            // Step 1: æŒ‰å¹´ä»½åˆ†çµ„ (Map: {year: [classroom1, classroom2, ...]})
            const groupedByYear = data.reduce((acc, item) => {
                const year = item.year;
                if (typeof year === 'number' && year > 1900) { 
                    if (!acc[year]) {
                        acc[year] = [];
                    }
                    acc[year].push(item);
                }
                return acc;
            }, {});

            const availableYears = Object.keys(groupedByYear).map(Number);
            
            // Step 2: éš¨æ©Ÿé¸å– 5 å€‹ä¸åŒçš„å¹´ä»½ (æˆ–æ‰€æœ‰å¯ç”¨çš„å¹´ä»½)
            const yearsToSelect = availableYears
                .sort(() => 0.5 - Math.random()) // éš¨æ©Ÿæ‰“äº‚
                .slice(0, 5); // å–å‰ 5 å€‹
            
            const finalSelection = [];

            // Step 3: å¾æ¯å€‹é¸å®šçš„å¹´ä»½ä¸­ï¼Œéš¨æ©ŸæŒ‘é¸ä¸€é–“æ•™å®¤
            yearsToSelect.forEach(year => {
                const classroomsInYear = groupedByYear[year];
                const randomIndex = Math.floor(Math.random() * classroomsInYear.length);
                finalSelection.push(classroomsInYear[randomIndex]);
            });

            return finalSelection;
        }


        // --- ç•«é¢åˆ‡æ› ---
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        // --- éŠæˆ²é–‹å§‹ (å·²æ›´æ–° Game B é‚è¼¯) ---
        function startGame(type) {
            if (!isDataLoaded) {
                alert("é¡Œç›®è³‡æ–™é‚„åœ¨è®€å–ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦...");
                return;
            }

            if (rawData.length < 5) {
                alert("è³‡æ–™åº«ä¸­çš„é¡Œç›®å°‘æ–¼ 5 é¡Œï¼Œç„¡æ³•é–‹å§‹éŠæˆ²ï¼\nç›®å‰çš„é¡Œç›®æ•¸ï¼š" + rawData.length);
                return;
            }

            if (type === 'A') {
                // éŠæˆ² A é‚è¼¯ï¼šéš¨æ©Ÿé¸ 5 å€‹
                let shuffled = [...rawData].sort(() => 0.5 - Math.random());
                currentLevelData = shuffled.slice(0, 5);
                initGameA();
                showScreen('game-a-screen');
            } else if (type === 'B') {
                // éŠæˆ² B é‚è¼¯ï¼šä½¿ç”¨ getUniqueYearClassrooms ç¢ºä¿å¹´ä»½ç¨ä¸€ç„¡äºŒ
                const selectedData = getUniqueYearClassrooms(rawData);

                if (selectedData.length < 5) {
                    alert(`æ’åºéŠæˆ² B å¤±æ•—ï¼è³‡æ–™åº«ä¸­ä¸åŒå¹´ä»½çš„æ•™å®¤ä¸è¶³ 5 é–“ï¼Œç›®å‰åªæœ‰ ${selectedData.length} é–“ã€‚\nè«‹æª¢æŸ¥ CSV æª”æ¡ˆï¼Œç¢ºä¿è‡³å°‘æœ‰ 5 å€‹ä¸åŒçš„å¹´ä»½è³‡æ–™ã€‚`);
                    return;
                }

                currentLevelData = selectedData;
                initGameB();
                showScreen('game-b-screen');
            }
        }

        // --- éŠæˆ² A é‚è¼¯ (é€£é€£çœ‹) ---
        function initGameA() {
            const leftContainer = document.getElementById('game-a-left');
            const rightContainer = document.getElementById('game-a-right');
            leftContainer.innerHTML = '';
            rightContainer.innerHTML = '';

            // å·¦å´ï¼šç…§ç‰‡ + æ”¾ç½®å€
            currentLevelData.forEach(item => {
                const slot = document.createElement('div');
                slot.className = 'card-slot';
                slot.dataset.id = item.id;
                slot.innerHTML = `<div class="img-box"><img src="${item.img}" alt="æ•™å®¤ç…§ç‰‡" onerror="this.src='https://via.placeholder.com/100?text=NoImage'"></div><div class="drop-zone" style="flex:1; margin-left:10px; min-height:40px; border-bottom:2px dashed #ccc;"></div>`;
                leftContainer.appendChild(slot);
                
                new Sortable(slot.querySelector('.drop-zone'), {
                    group: 'shared',
                    animation: 150
                });
            });

            // å³å´ï¼šåç¨± (æ‰“äº‚)
            let names = [...currentLevelData].sort(() => 0.5 - Math.random());
            names.forEach(item => {
                const div = document.createElement('div');
                div.className = 'draggable-item';
                div.textContent = item.name;
                div.dataset.id = item.id;
                rightContainer.appendChild(div);
            });

            new Sortable(rightContainer, {
                group: 'shared',
                animation: 150
            });
        }

        function checkGameA() {
            let correctCount = 0;
            const slots = document.querySelectorAll('#game-a-left .card-slot');
            
            slots.forEach(slot => {
                const targetId = slot.dataset.id;
                const dropZone = slot.querySelector('.drop-zone');
                const answerItem = dropZone.querySelector('.draggable-item');

                slot.classList.remove('wrong-answer', 'correct-answer');

                if (answerItem) {
                    if (answerItem.dataset.id === targetId) {
                        correctCount++;
                        slot.classList.add('correct-answer');
                    } else {
                        slot.classList.add('wrong-answer');
                    }
                } else {
                     slot.classList.add('wrong-answer');
                }
            });

            if (correctCount === 5) {
                alert("æ­å–œï¼å…¨éƒ¨ç­”å° ğŸ‰");
            } else {
                alert(`ç­”å° ${correctCount} é¡Œï¼Œè«‹ä¿®æ­£ç´…è‰²æ¡†æ¡†çš„éƒ¨åˆ†å†è©¦ä¸€æ¬¡ï¼`);
            }
        }

        // --- éŠæˆ² B é‚è¼¯ (æ’åº) ---
        function initGameB() {
            const source = document.getElementById('game-b-source');
            const target = document.getElementById('game-b-target');
            source.innerHTML = '';
            target.innerHTML = '';

            // å»ºç«‹å¡ç‰‡ (å…ˆæ‰“äº‚é †åºï¼Œå¢åŠ æŒ‘æˆ°æ€§)
            let shuffledData = [...currentLevelData].sort(() => 0.5 - Math.random());
            shuffledData.forEach(item => {
                const div = document.createElement('div');
                div.className = 'draggable-item';
                // *** ä¿®æ­£è™•ï¼šç§»é™¤ ${item.year} çš„é¡¯ç¤ºï¼Œåªä¿ç•™åç¨± ***
                div.innerHTML = `<div style="display:flex; align-items:center; gap:10px;"><div class="img-box" style="width:50px; height:40px;"><img src="${item.img}" onerror="this.src='https://via.placeholder.com/50?text=Error'"></div><span>${item.name}</span></div>`; 
                // *** é—œéµï¼šå¹´ä»½ä»ä¿ç•™åœ¨ data-year å±¬æ€§ä¸­ä¾›ç¨‹å¼æª¢æŸ¥ ***
                div.dataset.year = item.year;
                source.appendChild(div);
            });

            // å•Ÿç”¨æ‹–æ‹‰
            new Sortable(source, { group: 'timeline', animation: 150 });
            new Sortable(target, { group: 'timeline', animation: 150 });
        }

        function checkGameB() {
            const items = document.querySelectorAll('#game-b-target .draggable-item');
            if (items.length < 5) {
                alert("è«‹å°‡æ‰€æœ‰æ•™å®¤éƒ½ç§»åˆ°å³å´(æˆ–ä¸‹æ–¹)çš„æ™‚é–“è»¸å–”ï¼");
                return;
            }

            let isCorrect = true;
            let lastYear = -1;

            // æª¢æŸ¥é †åºæ˜¯å¦ç”±èˆŠåˆ°æ–° (å¹´ä»½å¿…é ˆéå¢)
            items.forEach(item => {
                const currentYear = parseInt(item.dataset.year);
                item.style.border = "none"; 

                // å¦‚æœç•¶å‰å¹´ä»½å°æ–¼ä¸Šä¸€å€‹å¹´ä»½ï¼Œå‰‡é †åºéŒ¯èª¤
                if (currentYear < lastYear) {
                    isCorrect = false;
                    item.style.border = "3px solid var(--wrong)";
                } 

                lastYear = currentYear;
            });

            if (isCorrect) {
                alert("æ­å–œï¼å…¨éƒ¨ç­”å° ğŸ‰ æ™‚å…‰æ—…äººå°±æ˜¯ä½ ï¼");
            } else {
                alert("é †åºå¥½åƒæœ‰é»æ€ªæ€ªçš„ï¼Œæœ‰æ¨™è¨˜ç´…è‰²çš„åœ°æ–¹è«‹èª¿æ•´ä¸€ä¸‹ï¼\næç¤ºï¼šç”±èˆŠ(ä¸Š)åˆ°æ–°(ä¸‹)ï¼");
            }
        }
    </script>
</body>
</html>
